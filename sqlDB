
# üóÑÔ∏è SQL ‚Äî Reset total + schema + RLS + triggers + **inst√¢ncia autom√°tica**
-- =========================================
-- OMR STUDIO ‚Ä¢ RESET TOTAL (Supabase/Postgres)
-- =========================================

-- Extens√µes
create extension if not exists pgcrypto;
create extension if not exists "uuid-ossp";

-- DROP na ordem (filhos -> pais)
drop table if exists public.mensagens  cascade;
drop table if exists public.instancias cascade;
drop table if exists public.faqs       cascade;
drop table if exists public.produtos   cascade;
drop table if exists public.usuarios   cascade;
drop table if exists public.empresas   cascade;

drop type if exists public.instancia_status cascade;
drop type if exists public.tom_persona cascade;

-- TYPES
create type public.tom_persona as enum ('josi','clara');
create type public.instancia_status as enum ('pending_qr','qrcode_ready','connected','disconnected','error');

-- updated_at trigger fn
create or replace function public.set_updated_at()
returns trigger language plpgsql as $$
begin
  new.updated_at = now();
  return new;
end;
$$;

-- Helper: slug da inst√¢ncia
create or replace function public.slug_instancia(p_uuid uuid)
returns text language sql immutable as $$
  select 'omr_' || replace(p_uuid::text, '-', '')
$$;

-- Tabelas
create table public.usuarios (
  id uuid primary key references auth.users(id) on delete cascade,
  nome text not null,
  email text not null unique,
  whatsapp text,
  empresa_id uuid,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.empresas (
  id uuid primary key default gen_random_uuid(),
  owner_user uuid not null references auth.users(id) on delete cascade,
  nome text not null,
  email_ref text not null,
  tom public.tom_persona default 'josi',
  horario text,
  endereco text,
  observacoes text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

alter table public.usuarios
  add constraint usuarios_empresa_fk
  foreign key (empresa_id) references public.empresas(id) on delete set null;

create table public.produtos (
  id uuid primary key default gen_random_uuid(),
  empresa_id uuid not null references public.empresas(id) on delete cascade,
  nome text not null,
  descricao text,
  preco numeric(10,2) not null check (preco >= 0.01),
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.faqs (
  id uuid primary key default gen_random_uuid(),
  empresa_id uuid not null references public.empresas(id) on delete cascade,
  pergunta text not null check (char_length(pergunta) between 3 and 300),
  resposta text not null check (char_length(resposta) between 1 and 1000),
  ordem int generated by default as identity,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.instancias (
  id uuid primary key default gen_random_uuid(),
  empresa_id uuid not null references public.empresas(id) on delete cascade,
  evolution_host text,
  evolution_instance text unique,
  status public.instancia_status not null default 'pending_qr',
  last_connected_at timestamptz,
  qr_base64 text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.mensagens (
  id uuid primary key default gen_random_uuid(),
  empresa_id uuid not null references public.empresas(id) on delete cascade,
  tipo text not null,
  detalhe jsonb,
  created_at timestamptz default now()
);

-- Triggers updated_at
create or replace trigger t_usuarios_updated
before update on public.usuarios
for each row execute function public.set_updated_at();

create or replace trigger t_empresas_updated
before update on public.empresas
for each row execute function public.set_updated_at();

create or replace trigger t_produtos_updated
before update on public.produtos
for each row execute function public.set_updated_at();

create or replace trigger t_faqs_updated
before update on public.faqs
for each row execute function public.set_updated_at();

create or replace trigger t_instancias_updated
before update on public.instancias
for each row execute function public.set_updated_at();

-- √çndices
create index if not exists idx_empresas_owner on public.empresas(owner_user);
create index if not exists idx_empresas_email on public.empresas(email_ref);
create index if not exists idx_produtos_empresa on public.produtos(empresa_id);
create index if not exists idx_faqs_empresa on public.faqs(empresa_id, ordem);
create index if not exists idx_instancias_empresa on public.instancias(empresa_id, status);
create index if not exists idx_mensagens_empresa on public.mensagens(empresa_id, created_at desc);

-- RLS ON
alter table public.usuarios   enable row level security;
alter table public.empresas   enable row level security;
alter table public.produtos   enable row level security;
alter table public.faqs       enable row level security;
alter table public.instancias enable row level security;
alter table public.mensagens  enable row level security;

-- Policies: empresas (dono)
drop policy if exists empresas_do_dono_r on public.empresas;
drop policy if exists empresas_do_dono_w on public.empresas;
drop policy if exists empresas_do_dono_u on public.empresas;
drop policy if exists empresas_do_dono_d on public.empresas;

create policy empresas_do_dono_r on public.empresas
  for select using (owner_user = auth.uid());
create policy empresas_do_dono_w on public.empresas
  for insert with check (owner_user = auth.uid());
create policy empresas_do_dono_u on public.empresas
  for update using (owner_user = auth.uid()) with check (owner_user = auth.uid());
create policy empresas_do_dono_d on public.empresas
  for delete using (owner_user = auth.uid());

-- Policies: usuarios (perfil)
drop policy if exists usuarios_so_eu_r on public.usuarios;
drop policy if exists usuarios_so_eu_w on public.usuarios;
drop policy if exists usuarios_so_eu_u on public.usuarios;
drop policy if exists usuarios_so_eu_d on public.usuarios;

create policy usuarios_so_eu_r on public.usuarios
  for select using (id = auth.uid());
create policy usuarios_so_eu_w on public.usuarios
  for insert with check (id = auth.uid());
create policy usuarios_so_eu_u on public.usuarios
  for update using (id = auth.uid()) with check (id = auth.uid());
create policy usuarios_so_eu_d on public.usuarios
  for delete using (id = auth.uid());

-- Policies: filhas por empresa do dono (inclui DELETE hard)
-- Produtos
drop policy if exists produtos_read  on public.produtos;
drop policy if exists produtos_write on public.produtos;
drop policy if exists produtos_edit  on public.produtos;
drop policy if exists produtos_kill  on public.produtos;

create policy produtos_read  on public.produtos
  for select using (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy produtos_write on public.produtos
  for insert with check (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy produtos_edit  on public.produtos
  for update using (empresa_id in (select id from public.empresas where owner_user = auth.uid()))
                      with check (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy produtos_kill  on public.produtos
  for delete using (empresa_id in (select id from public.empresas where owner_user = auth.uid()));

-- FAQs
drop policy if exists faqs_read  on public.faqs;
drop policy if exists faqs_write on public.faqs;
drop policy if exists faqs_edit  on public.faqs;
drop policy if exists faqs_kill  on public.faqs;

create policy faqs_read  on public.faqs
  for select using (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy faqs_write on public.faqs
  for insert with check (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy faqs_edit  on public.faqs
  for update using (empresa_id in (select id from public.empresas where owner_user = auth.uid()))
                      with check (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy faqs_kill  on public.faqs
  for delete using (empresa_id in (select id from public.empresas where owner_user = auth.uid()));

-- Instancias
drop policy if exists inst_read  on public.instancias;
drop policy if exists inst_write on public.instancias;
drop policy if exists inst_edit  on public.instancias;
drop policy if exists inst_kill  on public.instancias;

create policy inst_read  on public.instancias
  for select using (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy inst_write on public.instancias
  for insert with check (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy inst_edit  on public.instancias
  for update using (empresa_id in (select id from public.empresas where owner_user = auth.uid()))
                      with check (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy inst_kill  on public.instancias
  for delete using (empresa_id in (select id from public.empresas where owner_user = auth.uid()));

-- Mensagens
drop policy if exists msg_read  on public.mensagens;
drop policy if exists msg_write on public.mensagens;

create policy msg_read on public.mensagens
  for select using (empresa_id in (select id from public.empresas where owner_user = auth.uid()));
create policy msg_write on public.mensagens
  for insert with check (empresa_id in (select id from public.empresas where owner_user = auth.uid()));

-- √çndice √∫nico pra evolution_instance
create unique index if not exists ux_instancias_evolution_instance
on public.instancias (evolution_instance);

-- Trigger: criar inst√¢ncia ao inserir empresa
create or replace function public.create_instancia_on_empresa()
returns trigger language plpgsql as $$
begin
  insert into public.instancias (
    empresa_id,
    evolution_host,
    evolution_instance,
    status
  ) values (
    new.id,
    null, -- ser√° preenchido depois ao abrir Conex√µes
    public.slug_instancia(new.id),
    'pending_qr'::public.instancia_status
  );
  return new;
end;
$$;

drop trigger if exists tg_empresa_instancia on public.empresas;
create trigger tg_empresa_instancia
after insert on public.empresas
for each row execute function public.create_instancia_on_empresa();
